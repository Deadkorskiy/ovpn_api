# Как устроен деплой и как живет проект на сервере 

## Концепция 

Т.к. вся идея в том, чтобы держать на сервере 1 контейнер в котором будет и vpn 
и api которе им управляет - то если мы на один сервер деплоим 2 контейнера то на нем 
будет 2 папки с исходниками api и впнами соответсвенно. 

Все деплоится в папку `/var/apps` - **все приложения** попадают в нее. Т.к. 
"самое главное" в текущем проекте это впн-сервер, то все крутится вокруг него. Т.е.
напримере `opt/deploy/files/staging/vpn/openvpn/c1` на целевом сервере будет создана 
папка `/var/apps/c1` - в которой будет и сам впн и исходники для управления им.

## Структура файлов и папок на сервере:

```commandline
root@ubuntu-s-1vcpu-1gb-fra1-01:/var/apps/c1# ls -la
total 16
drwxr-xr-x 4 root   root   4096 Oct 18 22:35 .
drwxr-xr-x 3 root   root   4096 Oct 18 22:35 ..
drwxr-xr-x 5 deploy deploy 4096 Oct 19 00:15 ansistrano
drwxr-xr-x 4 deploy deploy 4096 Oct 18 22:58 docker_persistent
```

ansistrano - сюда деплоятся исходники через git

docker_persistent - папка для файлов и папок которые будут маунтится в контейнер.

```commandline
root@ubuntu-s-1vcpu-1gb-fra1-01:/var/apps/c1/docker_persistent# ls -la
total 16
drwxr-xr-x 4 deploy deploy 4096 Oct 18 22:58 .
drwxr-xr-x 4 root   root   4096 Oct 18 22:35 ..
drwxrwxr-x 3 deploy deploy 4096 Oct 18 22:36 openvpn
drwxr-xr-x 4 root   root   4096 Oct 19 00:15 var
``` 
Тут все очевидно: 

openvpn - это `onetimevpn_vpn/opt/deploy/files/staging/vpn/openvpn/c1/openvpn`

var - это `onetimevpn_vpn/var`

## Как деплоить, описание плейбуков

Плейбук запускается так: `onetimevpn_vpn/opt/deploy $ ansible-playbook restart_docker.yml `

**!!!Важно: перед запуском плейбука - посмотрите в самом плейбуке на каких хостах он будет выполнятся!!!**

Первым делом на тольео что созданом сервере выполняется файл `pre_setup.sh`, он создаст пользователя с ключами, чтобы к серверу мог подключиться ansible **выполняется 1 раз**

Потом для сервера выполняется плейбук `prepare_host.yml` он установит на сервер гит, сишный комплиятор, докер, и т.д. **выполняется 1 раз**

Потом отправим на сервер нашу папку с настройками впн-а плейбуком `send_vpn_dir.yml`  **выполняется 1 раз, при поатороном вызове- затрет сертификаты пользователей**

Потом отправим а сервер исходники плейбуком `update_app.yml`. **Можно вызывать много раз.** Что он сделает: 
- закинет на сервер исходники в папку `/var/apps/<YOUR_CLUSTER>/ansistrano/current`
- положит `local_settings.py` в `src/settings` и заменит `etc/docker-compose.yml` тем который лежит в  `onetimevpn_vpn/opt/deploy/files/staging/vpn/openvpn/<YOUR_CLUSTER>`

Теперь соберем docker image плейбуком `build_docker.yml` **Стоит вызывать только первый раз и если обновлялся Dokerfile**

Ну и все! Теперь можно запускать и останавливать контейнер плейбуками `restart_docker.yml` и `stop_docker.yml` **Можно вызывать много раз**  

## Самые частые сценарии использования, например обновление: 
Рассмотрим кейс, когда сервис уже крутится на сервере и надо просто что-то обновить.
А таком случае надо выполнить всего два плейбука: `update_app.yml` и `restart_docker.yml`.
Под этот же перечень команд попадает ситуация когда надо обновить конфигурацию впна: на хостовой машине
в `docker_persistent` меняем ее **ручками** и делаем `restart_docker.yml`. 

## Как создать production конфигурацию 
Все просто: 
- копируем папку staging с наименованием production и меняем настройки (об этом ниже)
- правим путь со staging на production в 'ansible.cfg'

**Что именно править и что где используется**:
- Начать стоит с ключей, генерим пару командой  `# ssh-keygen -t rsa -C "deploy" -b 4096`
    - сохраняем их в папку  `keys`
    - обновляем ими файл `pre_setup.sh`
    - публичный ключ добавляем в deploy keys в github, gitlab и т.д.
- Конечно, надо обновить `inventories.yml`
- Создать новый кластер при помощи `onetimevpn_vpn/opt/cluster_generator` и перенести получившиеся настройки в свою папку `production`
- Т.к. каждый кластер работает на определенном порту, с определенными настройками API управления 
требуется обновить в каждом кластере настройки docker-compose.yml и local_settings.py 
**тут стоит обратить внимание на то, что порты которые открываются докером - должно не блочится firewall-ом (см. inventories.yml). также если на сервере работает больше 1 впна их порты не должны конфликтовать.**     
  
## Советы и рекомендации
- Внимательно смотрите на каких хостах будет выполняться плейбук
- Внимательно смотрите что пропсанно в  `inventories.yml` какие пути будут использованы, что куда будет скопированно
- Если есть в чем то сомнения забекпте папку с сертификатыми пользователей через `cp`
